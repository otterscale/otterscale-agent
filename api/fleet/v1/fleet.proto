edition = "2023";

package otterscale.fleet.v1;

import "api/annotations.proto";

option go_package = "github.com/otterscale/otterscale-agent/api/fleet/v1;pb";

// FleetService manages the lifecycle of agent-to-server tunnel connections,
// including registration and health checking.
service FleetService {
  // ListClusters returns all cluster identifiers that the current agent
  // is registered to. This is used to discover which clusters are available
  // for tunnel connections.
  rpc ListClusters(ListClustersRequest) returns (ListClustersResponse) {
    option (otterscale.api.feature) = {
      name: "fleet-enabled"
    };
  };

  // Register allows an agent to register itself with the tunnel server.
  // The agent sends its cluster identity and tunnel port; the server responds
  // with its fingerprint so the agent can verify the tunnel connection.
  rpc Register(RegisterRequest) returns (RegisterResponse) {
    option (otterscale.api.feature) = {
      name: "fleet-enabled"
    };
  };

  // GetAgentManifest returns a multi-document YAML manifest for installing
  // the otterscale agent on a target Kubernetes cluster. The manifest
  // includes a Namespace, ServiceAccount, ClusterRoleBinding (binding the
  // caller to cluster-admin), and a Deployment running the agent.
  rpc GetAgentManifest(GetAgentManifestRequest) returns (GetAgentManifestResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
    option (otterscale.api.feature) = {
      name: "fleet-enabled"
    };
  };
}

message Cluster {
  // The cluster name.
  string name = 1;

  // The version of the agent binary (e.g. "v1.2.3"), set at build time.
  string agent_version = 2;
}

// ListClustersRequest is an empty request message for listing clusters.
message ListClustersRequest {}

// ListClustersResponse contains the list of clusters the agent is registered to.
message ListClustersResponse {
  // The list of clusters.
  repeated Cluster clusters = 1;
}

// RegisterRequest contains the agent's cluster identity and a CSR for
// mTLS certificate issuance.
message RegisterRequest {
  // The cluster identifier this agent belongs to.
  string cluster = 1;

  // PEM-encoded PKCS#10 certificate signing request. The server signs
  // this with its internal CA and returns the issued certificate.
  bytes csr = 2;

    // The agent identifier this agent uses to register with the server.
  string agent_id = 3;

    // The version of the agent binary (e.g. "v1.2.3"), set at build time.
  string agent_version = 4;
}

// GetAgentManifestRequest identifies the target cluster for which
// the agent installation manifest should be generated.
message GetAgentManifestRequest {
  // The cluster name the agent will register under.
  string cluster = 1;
}

// GetAgentManifestResponse contains the multi-document YAML manifest
// that can be applied via kubectl to install the agent.
message GetAgentManifestResponse {
  // Multi-document YAML containing Namespace, ServiceAccount,
  // ClusterRoleBinding, and Deployment resources.
  string manifest = 1;

  // URL with an embedded HMAC token that serves the manifest as raw
  // YAML. Users can run `kubectl apply -f <url>` directly.
  string url = 2;
}

// RegisterResponse contains a CA-signed certificate and the CA
// certificate so the agent can establish an mTLS tunnel connection.
message RegisterResponse {
  // The loopback endpoint reserved for this cluster tunnel.
  string endpoint = 1;

  // PEM-encoded X.509 certificate signed by the server's CA.
  bytes certificate = 2;

  // PEM-encoded CA certificate for verifying the tunnel server.
  bytes ca_certificate = 3;

  // The version of the server binary (e.g. "v1.2.3"), set at build time.
  // Agents compare this against their own version to decide whether a
  // self-update is needed.
  string server_version = 4;
}
